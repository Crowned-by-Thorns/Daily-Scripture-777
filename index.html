<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scripture of the Day</title>
  <meta name="description" content="A page that shares a KJV Bible verse and a simple explanation each visit, with search." />
  <style>
    /* ---------- Page + background ---------- */
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #2b2118;
      background-color: #f5e9d4;
      background-image: url('assets/bg.jpg'); /* your cross background */
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }

    /* ---------- Header ---------- */
    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(255, 255, 255, 0.65);
      border-bottom: 1px solid #eadfcd;
      padding: 10px 12px;
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      backdrop-filter: blur(3px);
    }
    h1 { margin: 0; color: #a86b3d; font-size: 18px; letter-spacing: .2px; white-space: nowrap; }

    /* ---------- Search ---------- */
    .search-wrap { position: relative; }
    .search {
      width: 100%;
      border: 1px solid #e5d6c2; background: #fff;
      padding: 10px 12px; border-radius: 12px; font-size: 14px;
      box-shadow: 0 1px 0 #f5ece0 inset;
    }
    .results {
      position: absolute; left: 0; right: 0; top: calc(100% + 6px);
      background: rgba(255,255,255,0.95);
      border: 1px solid #eadfcd; border-radius: 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.15);
      max-height: 50vh; overflow: auto; display: none;
    }
    .results.show { display: block; }
    .hit { padding: 10px 12px; border-bottom: 1px solid #f0e6d7; cursor: pointer; }
    .hit:last-child { border-bottom: 0; }
    .hit:hover, .hit.active { background: #fff7ea; }
    .hit .ref { color: #a86b3d; font-weight: 600; }
    .hit .snippet { font-size: 13px; color: #5b4a3e; margin-top: 2px; }

    /* ---------- Buttons ---------- */
    .btns { display: flex; gap: 8px; }
    button {
      margin: 0;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #e5d6c2;
      background: #fff;
      box-shadow: 0 1px 0 #f5ece0 inset;
      color: #2b2118;
      font-size: 14px;
    }
    button:hover { background: #fff7ea; cursor: pointer; }

    /* ---------- Verse card (bubble) ---------- */
    .card {
      background: rgba(255, 250, 241, 0.85);
      border-radius: 14px;
      box-shadow: 0 20px 48px rgba(0,0,0,.18), inset 0 0 1px #eadfcd;
      max-width: 800px;
      padding: 20px;
      margin: clamp(220px, 60vh, 360px) auto 18px;
      backdrop-filter: blur(4px);
      animation: fade-in 500ms ease-out both;
    }

    /* ---------- Explanation card ---------- */
    .explain {
      background: rgba(255, 255, 255, 0.88);
      border-radius: 14px;
      box-shadow: 0 16px 36px rgba(0,0,0,.12), inset 0 0 1px #eadfcd;
      max-width: 800px;
      padding: 18px;
      margin: 12px auto 40px;
      backdrop-filter: blur(3px);
      animation: fade-in 600ms ease-out both;
    }
    .explain .label { color:#8b7663; font-weight:600; margin-bottom:8px; }
    .explain .content { font-size: 18px; line-height: 1.7; }

    /* ---------- Small / Tall screens ---------- */
    @media (max-width: 420px) {
      .card { margin-top: clamp(170px, 56vh, 310px); }
      .explain .content { font-size: 17px; }
      header { grid-template-columns: 1fr; }
      .btns { justify-content: flex-end; }
    }
    @media (min-height: 900px) { .card { margin-top: clamp(280px, 62vh, 420px); } }

    /* ---------- Desktop / wide-screen tweaks ---------- */
    @media (min-width: 1024px) {
      body { background-position: center 32%; }
      .card { margin-top: clamp(300px, 68vh, 520px); max-width: 840px; }
      .explain { max-width: 840px; }
    }
    @media (min-aspect-ratio: 16/10) and (min-width: 1200px) {
      .card { margin-top: clamp(340px, 72vh, 560px); }
    }

    /* ---------- Typography ---------- */
    .ref  { color: #a86b3d; font-weight: 600; }
    .text { font-size: 22px; line-height: 1.6; background: #ffefb8; padding: 12px; border-radius: 10px; }
    @media (max-width: 420px) { .text { font-size: 20px; } }

    /* ---------- Effects ---------- */
    @keyframes fade-in { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @media (prefers-reduced-motion: reduce) { .card, .explain { animation: none; } }
  </style>
</head>
<body>
  <header>
    <h1>Scripture of the Day</h1>

    <!-- Search -->
    <div class="search-wrap">
      <input id="q" class="search" type="search" placeholder="Search: e.g., John 3:16 or 'shepherd peace'â€¦" autocomplete="off" />
      <div id="results" class="results" role="listbox" aria-label="Search results"></div>
    </div>

    <div class="btns">
      <button id="againBtn" aria-label="Another verse">âŸ³ Another verse</button>
      <button id="speakBtn" aria-label="Replay">ðŸ”Š Replay</button>
    </div>
  </header>

  <main>
    <!-- Main KJV verse -->
    <section class="card" aria-live="polite">
      <div class="ref" id="ref"></div>
      <div class="text" id="text"></div>
    </section>

    <!-- Plain-English explanation -->
    <section class="explain" id="explainBox" hidden>
      <div class="label">What this means</div>
      <div class="content" id="explainText"></div>
    </section>
  </main>

  <script>
    /* ===================== Data loaders ===================== */
    async function loadJSON(path) {
      const r = await fetch(path, { cache: 'no-store' });
      if (!r.ok) throw new Error(path + ' not found');
      return r.json();
    }

    // Your kjv.json is flat, like { "Genesis 1:1": "text", ... }.
    // Convert it to nested { Book: { Chapter: { Verse: "text" }}}.
    function normalizeFlatKJV(raw) {
      const out = {};
      for (const key in raw) {
        const m = key.match(/^([1-3]?\s*[A-Za-z]+)\s+(\d+):(\d+)$/);
        if (!m) continue;
        const book = m[1].replace(/\s+/g,' ').trim();
        const ch   = String(m[2]);
        const vs   = String(m[3]);
        const text = raw[key];
        if (!out[book]) out[book] = {};
        if (!out[book][ch]) out[book][ch] = {};
        out[book][ch][vs] = text;
      }
      return out;
    }

    function refString(r) { return `${r.book} ${r.chapter}:${r.verse}`; }
    function pickRandom(a) { return a[Math.floor(Math.random()*a.length)]; }

    // Flatten nested KJV for searching
    function flatten(db) {
      const out = [];
      for (const book in db) {
        for (const ch in db[book]) {
          for (const v in db[book][ch]) {
            const text = db[book][ch][v];
            out.push({ book, chapter: ch, verse: v, text, ref: `${book} ${ch}:${v}`.toLowerCase() });
          }
        }
      }
      return out;
    }

    // Parse "John 3:16" style queries
    function parseRefQuery(s) {
      const m = s.trim().match(/^([1-3]?\s*[A-Za-z]+)\s+(\d+):(\d+)$/);
      return m ? { book: m[1].replace(/\s+/g, ' ').trim(), chapter: m[2], verse: m[3] } : null;
    }

    /* ===================== Speech (US female) ===================== */
    const PREFERRED_NAMES = ['Samantha','Google US English','Microsoft Aria','Microsoft Jenny','Microsoft Zira','Allison','Joanna'];
    let chosenVoice = null;

    function pickVoice() {
      const voices = window.speechSynthesis.getVoices() || [];
      for (const name of PREFERRED_NAMES) {
        const v = voices.find(v => (v.name || '').toLowerCase().includes(name.toLowerCase()) &&
                                   (v.lang || '').toLowerCase().startsWith('en-us'));
        if (v) return v;
      }
      const enUSFemale = voices.find(v => (v.lang || '').toLowerCase().startsWith('en-us') &&
        /female|samantha|aria|jenny|zira|allison|joanna/i.test(v.name || ''));
      if (enUSFemale) return enUSFemale;
      const enUS = voices.find(v => (v.lang || '').toLowerCase().startsWith('en-us'));
      if (enUS) return enUS;
      const enFemale = voices.find(v => /en(-|_|$)/i.test(v.lang || '') &&
        /female|samantha|aria|jenny|zira|allison|joanna|karen|victoria/i.test(v.name || ''));
      if (enFemale) return enFemale;
      const anyEn = voices.find(v => /en(-|_|$)/i.test(v.lang || ''));
      return anyEn || voices[0] || null;
    }
    function ensureVoices(thenSpeakText) {
      const tryLoad = () => {
        const list = window.speechSynthesis.getVoices();
        if (!list || list.length === 0) return false;
        chosenVoice = pickVoice();
        if (thenSpeakText) speak(thenSpeakText);
        return true;
      };
      if (!tryLoad()) {
        const iv = setInterval(() => { if (tryLoad()) clearInterval(iv); }, 120);
        window.speechSynthesis.onvoiceschanged = () => { if (tryLoad()) window.speechSynthesis.onvoiceschanged = null; };
      }
    }
    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US'; u.rate = 0.96; u.pitch = 1.03;
      if (chosenVoice) u.voice = chosenVoice;
      window.speechSynthesis.speak(u);
    }

    /* ===================== Page logic ===================== */
    let KJV = null;          // nested (Book -> Chapter -> Verse)
    let verses = null;       // flattened for search
    let explains = null;     // explanations nested
    let current = null;

    function showVerse(r) {
      document.getElementById('ref').textContent = `${r.book} ${r.chapter}:${r.verse}`;
      document.getElementById('text').textContent = r.text;
      current = r;

      const exp = explains?.[r.book]?.[r.chapter]?.[r.verse];
      const box = document.getElementById('explainBox');
      const txt = document.getElementById('explainText');
      if (exp) { txt.textContent = exp; box.hidden = false; }
      else { txt.textContent = 'Explanation coming soon.'; box.hidden = false; }

      setTimeout(() => { if (!chosenVoice) ensureVoices(r.text); else speak(r.text); }, 150);
    }

    async function rollRandom() {
      if (!KJV)      KJV      = normalizeFlatKJV(await loadJSON('data/kjv.json')); // <â€” key change
      if (!verses)   verses   = flatten(KJV);
      if (!explains) explains = await loadJSON('data/explanations.json').catch(()=> ({}));
      showVerse(verses[Math.floor(Math.random()*verses.length)]);
      history.replaceState(null,'','#');
    }

    /* ===================== Search UI ===================== */
    const q = document.getElementById('q');
    const results = document.getElementById('results');
    let activeIndex = -1;
    function clearResults(){ results.innerHTML = ''; results.classList.remove('show'); activeIndex = -1; }
    function renderResults(items) {
      results.innerHTML = '';
      items.slice(0, 30).forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'hit';
        div.setAttribute('role','option');
        div.dataset.index = i;
        div.innerHTML = `<div class="ref">${r.book} ${r.chapter}:${r.verse}</div>
                         <div class="snippet">${r.text.replace(/</g,'&lt;')}</div>`;
        div.addEventListener('click', () => { clearResults(); showVerse(r); q.blur(); });
        results.appendChild(div);
      });
      results.classList.toggle('show', items.length > 0);
      activeIndex = -1;
    }
    function scoreVerse(v, terms) {
      let score = 0;
      const hay = (v.ref + ' ' + v.text).toLowerCase();
      for (const t of terms) if (hay.includes(t)) score += 1;
      return score;
    }
    function searchVerses(query) {
      if (!verses) return [];
      const refQ = parseRefQuery(query);
      if (refQ) {
        const t = (KJV?.[refQ.book]?.[refQ.chapter]?.[refQ.verse]) || null;
        if (t) return [{...refQ, text: t}];
      }
      const terms = query.toLowerCase().trim().split(/\s+/).filter(Boolean);
      if (terms.length === 0) return [];
      const hits = [];
      for (const v of verses) {
        const s = scoreVerse(v, terms);
        if (s === terms.length) hits.push(v); // all terms present
      }
      return hits.slice(0, 200);
    }

    function onQueryInput() {
      const query = q.value.trim();
      if (query.length < 2) { clearResults(); return; }
      if (!verses) return;
      renderResults(searchVerses(query));
    }

    q.addEventListener('input', onQueryInput);
    q.addEventListener('focus', onQueryInput);
    q.addEventListener('keydown', (e) => {
      const items = Array.from(results.querySelectorAll('.hit'));
      if (!items.length) return;
      if (e.key === 'ArrowDown') { e.preventDefault(); activeIndex = (activeIndex + 1) % items.length; }
      else if (e.key === 'ArrowUp') { e.preventDefault(); activeIndex = (activeIndex - 1 + items.length) % items.length; }
      else if (e.key === 'Enter') { e.preventDefault(); (items[activeIndex] || items[0])?.click(); }
      else if (e.key === 'Escape') { clearResults(); q.blur(); }
      items.forEach(el => el.classList.remove('active'));
      if (activeIndex >= 0) items[activeIndex].classList.add('active');
    });
    document.addEventListener('click', (e) => { if (!results.contains(e.target) && e.target !== q) clearResults(); });

    /* ===================== Init ===================== */
    async function init() {
      ensureVoices();
      await rollRandom(); // first verse
      document.getElementById('againBtn').addEventListener('click', rollRandom);
      document.getElementById('speakBtn').addEventListener('click', () => current && speak(current.text));

      window.addEventListener('pageshow', (e)=>{ if (e.persisted) rollRandom(); });
      document.addEventListener('visibilitychange', ()=> {
        const nav = performance.getEntriesByType('navigation')[0];
        if (document.visibilityState === 'visible' && nav && nav.type === 'back_forward') rollRandom();
      });

      // Background loads (in case first call hit cache)
      if (!KJV)      KJV      = normalizeFlatKJV(await loadJSON('data/kjv.json'));
      if (!verses)   verses   = flatten(KJV);
      if (!explains) explains = await loadJSON('data/explanations.json').catch(()=> ({}));
    }
    init();
  </script>
</body>
</html>
